// -- Sammy.js -- plugins/sammy.storage.js
// http://sammyjs.org
// Version: 0.7.0
// Built: 2011-08-08T12:31:53+0200
(function(a){Sammy=Sammy||{},Sammy.Store=function(b){var c=this;this.options=b||{},this.name=this.options.name||"store",this.element=this.options.element||"body",this.$element=a(this.element),a.isArray(this.options.type)?a.each(this.options.type,function(a,b){if(Sammy.Store.isAvailable(b)){c.type=b;return!1}}):this.type=this.options.type||"memory",this.meta_key=this.options.meta_key||"__keys__",this.storage=new Sammy.Store[Sammy.Store.stores[this.type]](this.name,this.element,this.options)},Sammy.Store.stores={memory:"Memory",data:"Data",local:"LocalStorage",session:"SessionStorage",cookie:"Cookie"},a.extend(Sammy.Store.prototype,{isAvailable:function(){if(a.isFunction(this.storage.isAvailable))return this.storage.isAvailable();!0},exists:function(a){return this.storage.exists(a)},set:function(a,b){var c=typeof b=="string"?b:JSON.stringify(b);a=a.toString(),this.storage.set(a,c),a!=this.meta_key&&(this._addKey(a),this.$element.trigger("set-"+this.name,{key:a,value:b}),this.$element.trigger("set-"+this.name+"-"+a,{key:a,value:b}));return b},get:function(a){var b=this.storage.get(a);if(typeof b=="undefined"||b==null||b=="")return b;try{return JSON.parse(b)}catch(c){return b}},clear:function(a){this._removeKey(a);return this.storage.clear(a)},clearAll:function(){var a=this;this.each(function(b,c){a.clear(b)})},keys:function(){return this.get(this.meta_key)||[]},each:function(a){var b=0,c=this.keys(),d;for(b;b<c.length;b++){d=a(c[b],this.get(c[b]));if(d===!1)return!1}},filter:function(a){var b=[];this.each(function(c,d){a(c,d)&&b.push([c,d]);return!0});return b},first:function(a){var b=!1;this.each(function(c,d){if(a(c,d)){b=[c,d];return!1}});return b},fetch:function(a,b){return this.exists(a)?this.get(a):this.set(a,b.apply(this))},load:function(b,c,d){var e=this;a.get(c,function(a){e.set(b,a),d&&d.apply(this,[a])})},_addKey:function(b){var c=this.keys();a.inArray(b,c)==-1&&c.push(b),this.set(this.meta_key,c)},_removeKey:function(b){var c=this.keys(),d=a.inArray(b,c);d!=-1&&c.splice(d,1),this.set(this.meta_key,c)}}),Sammy.Store.isAvailable=function(a){try{return Sammy.Store[Sammy.Store.stores[a]].prototype.isAvailable()}catch(b){return!1}},Sammy.Store.Memory=function(a,b){this.name=a,this.element=b,this.namespace=[this.element,this.name].join("."),Sammy.Store.Memory.store=Sammy.Store.Memory.store||{},Sammy.Store.Memory.store[this.namespace]=Sammy.Store.Memory.store[this.namespace]||{},this.store=Sammy.Store.Memory.store[this.namespace]},a.extend(Sammy.Store.Memory.prototype,{isAvailable:function(){return!0},exists:function(a){return typeof this.store[a]!="undefined"},set:function(a,b){return this.store[a]=b},get:function(a){return this.store[a]},clear:function(a){delete this.store[a]}}),Sammy.Store.Data=function(b,c){this.name=b,this.element=c,this.$element=a(c)},a.extend(Sammy.Store.Data.prototype,{isAvailable:function(){return!0},exists:function(a){return!!this.$element.data(this._key(a))},set:function(a,b){return this.$element.data(this._key(a),b)},get:function(a){return this.$element.data(this._key(a))},clear:function(a){this.$element.removeData(this._key(a))},_key:function(a){return["store",this.name,a].join(".")}}),Sammy.Store.LocalStorage=function(a,b){this.name=a,this.element=b},a.extend(Sammy.Store.LocalStorage.prototype,{isAvailable:function(){return"localStorage"in window&&window.location.protocol!="file:"},exists:function(a){return this.get(a)!=null},set:function(a,b){return window.localStorage.setItem(this._key(a),b)},get:function(a){return window.localStorage.getItem(this._key(a))},clear:function(a){window.localStorage.removeItem(this._key(a))},_key:function(a){return["store",this.element,this.name,a].join(".")}}),Sammy.Store.SessionStorage=function(a,b){this.name=a,this.element=b},a.extend(Sammy.Store.SessionStorage.prototype,{isAvailable:function(){return"sessionStorage"in window&&window.location.protocol!="file:"&&a.isFunction(window.sessionStorage.setItem)},exists:function(a){return this.get(a)!=null},set:function(a,b){return window.sessionStorage.setItem(this._key(a),b)},get:function(a){var b=window.sessionStorage.getItem(this._key(a));b&&typeof b.value!="undefined"&&(b=b.value);return b},clear:function(a){window.sessionStorage.removeItem(this._key(a))},_key:function(a){return["store",this.element,this.name,a].join(".")}}),Sammy.Store.Cookie=function(a,b,c){this.name=a,this.element=b,this.options=c||{},this.path=this.options.path||"/",this.expires_in=this.options.expires_in||1209600},a.extend(Sammy.Store.Cookie.prototype,{isAvailable:function(){return"cookie"in document&&window.location.protocol!="file:"},exists:function(a){return this.get(a)!=null},set:function(a,b){return this._setCookie(a,b)},get:function(a){return this._getCookie(a)},clear:function(a){this._setCookie(a,"",-1)},_key:function(a){return["store",this.element,this.name,a].join(".")},_getCookie:function(a){var b=this._key(a).replace(/(\.|\*|\(|\)|\[|\])/g,"\\$1"),c=document.cookie.match("(^|;\\s)"+b+"=([^;]*)(;|$)");return c?c[2]:null},_setCookie:function(a,b,c){c||(c=this.expires_in*1e3);var d=new Date;d.setTime(d.getTime()+c);var e=[this._key(a),"=",b,"; expires=",d.toGMTString(),"; path=",this.path].join("");document.cookie=e}}),Sammy.Storage=function(b){this.use(Sammy.JSON),this.stores=this.stores||{},this.store=function(b,c){if(typeof this.stores[b]=="undefined"){var d="clear"+b.substr(0,1).toUpperCase()+b.substr(1);this.stores[b]=new Sammy.Store(a.extend({name:b,element:this.element_selector},c||{})),this[b]=function(c,d){return typeof d=="undefined"?this.stores[b].get(c):a.isFunction(d)?this.stores[b].fetch(c,d):this.stores[b].set(c,d)},this[d]=function(){return this.stores[b].clearAll()},this.helper(b,function(){return this.app[b].apply(this.app,arguments)}),this.helper(d,function(){return this.app[d]()})}return this.stores[b]},this.helpers({store:function(){return this.app.store.apply(this.app,arguments)}})},Sammy.Session=function(b,c){this.use(Sammy.Storage),this.store("session",a.extend({type:["local","cookie","memory"]},c))},Sammy.Cache=function(b,c){this.use(Sammy.Storage),this.cache_partials=!0,this.store("cache",a.extend({type:["local","session","memory"]},c))}})(jQuery)